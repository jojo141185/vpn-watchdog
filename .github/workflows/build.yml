name: Build and Release Manager

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      target_os:
        description: 'Target Platform'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - ubuntu-latest
          - windows-latest
          - macos-latest

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            os_short: linux
            exe_ext: ""
          - os: windows-latest
            os_short: windows
            exe_ext: ".exe"
          - os: macos-latest
            os_short: macos
            exe_ext: ""

    steps:
      # --- 1. FILTER CHECK ---
      # Check if we should run this specific matrix job based on manual input
      - name: Check Platform Filter
        id: check_filter
        shell: bash
        run: |
          TARGET="${{ inputs.target_os }}"
          CURRENT="${{ matrix.os }}"
          # Default to 'all' if triggered by push (TARGET will be empty)
          if [[ -z "$TARGET" ]]; then TARGET="all"; fi
          
          if [[ "$TARGET" != "all" && "$TARGET" != "$CURRENT" ]]; then
            echo "Skipping build for $CURRENT"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout Code
        if: steps.check_filter.outputs.skip != 'true'
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        if: steps.check_filter.outputs.skip != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # --- VERSION LOGIC ---
      - name: Inject Version Info
        if: steps.check_filter.outputs.skip != 'true'
        shell: bash
        run: |
          CURRENT_DATE=$(date -u +'%Y-%m-%d %H:%M UTC')
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            # RELEASE MODE (Stable)
            VERSION_STR="${{ github.ref_name }}"
            TARGET_TAG="${{ github.ref_name }}"
            PRERELEASE=false
            MAKE_LATEST=true
            echo "BUILD_MODE=stable" >> $GITHUB_ENV
          else
            # DEV MODE (Rolling Release)
            BRANCH_NAME="${{ github.ref_name }}"
            # Sanitize branch name just in case
            BRANCH_NAME=${BRANCH_NAME/\//-} 
            VERSION_STR="dev-${BRANCH_NAME}-${SHORT_SHA}"
            TARGET_TAG="latest-${BRANCH_NAME}"
            PRERELEASE=true
            MAKE_LATEST=false
            echo "BUILD_MODE=dev" >> $GITHUB_ENV
          fi
          
          echo "Target Tag: $TARGET_TAG"
          echo "TARGET_TAG=$TARGET_TAG" >> $GITHUB_ENV
          echo "IS_PRERELEASE=$PRERELEASE" >> $GITHUB_ENV
          echo "MAKE_LATEST=$MAKE_LATEST" >> $GITHUB_ENV
          
          # Overwrite src/version.py
          echo "BUILD_TAG = '$VERSION_STR'" > src/version.py
          echo "COMMIT_HASH = '${{ github.sha }}'" >> src/version.py
          echo "BUILD_DATE = '$CURRENT_DATE'" >> src/version.py
          
          cat src/version.py

      - name: Install System Dependencies (Linux)
        if: matrix.os == 'ubuntu-latest' && steps.check_filter.outputs.skip != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y gir1.2-appindicator3-0.1 libappindicator3-dev python3-tk

      - name: Install Python Dependencies
        if: steps.check_filter.outputs.skip != 'true'
        run: |
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build Binary
        if: steps.check_filter.outputs.skip != 'true'
        run: |
          pyinstaller --noconfirm --onefile --windowed --clean --name="vpn-watchdog" src/main.py

      # --- UPLOAD TO RELEASE ---
      - name: Upload to Release
        if: steps.check_filter.outputs.skip != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TARGET_TAG }}
          files: |
            dist/vpn-watchdog${{ matrix.exe_ext }}
          name: ${{ env.TARGET_TAG }}
          body: "Build: ${{ env.BUILD_TAG }} | Commit: ${{ github.sha }}"
          draft: false
          prerelease: ${{ env.IS_PRERELEASE }}
          overwrite_files: true
          make_latest: ${{ env.MAKE_LATEST }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}