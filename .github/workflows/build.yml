name: Build and Release Manager

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      target_os:
        description: 'Target Platform'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - ubuntu-24.04
          - windows-latest
          - macos-latest

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # Use Ubuntu 24.04 for better backward compatibility of Linux binaries
        os: [ubuntu-24.04, windows-latest, macos-latest]
        include:
          - os: ubuntu-24.04
            os_name: linux
            setup_script: setup.sh
            binary_name: vpn-watchdog
          - os: windows-latest
            os_name: windows
            setup_script: setup.bat
            binary_name: vpn-watchdog.exe
          - os: macos-latest
            os_name: darwin # Standard nomenclature for macOS
            setup_script: setup.command
            binary_name: vpn-watchdog

    steps:
      # --- 1. FILTER CHECK ---
      # Check if we should run this specific matrix job based on manual input
      - name: Check Platform Filter
        id: check_filter
        shell: bash
        run: |
          TARGET="${{ inputs.target_os }}"
          CURRENT="${{ matrix.os }}"
          # Default to 'all' if triggered by push (TARGET will be empty)
          if [[ -z "$TARGET" ]]; then TARGET="all"; fi
          
          if [[ "$TARGET" != "all" && "$TARGET" != "$CURRENT" ]]; then
            echo "Skipping build for $CURRENT"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout Code
        if: steps.check_filter.outputs.skip != 'true'
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        if: steps.check_filter.outputs.skip != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # --- VERSION & ARCH LOGIC ---
      - name: Inject Version and Detect Arch
        if: steps.check_filter.outputs.skip != 'true'
        shell: bash
        run: |
          CURRENT_DATE=$(date -u +'%Y-%m-%d %H:%M UTC')
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          
          # Detect Architecture (amd64, arm64, x86_64)
          RAW_ARCH=$(uname -m)
          # Normalize Arch names
          if [[ "$RAW_ARCH" == "x86_64" ]]; then ARCH="amd64"; 
          elif [[ "$RAW_ARCH" == "aarch64" || "$RAW_ARCH" == "arm64" ]]; then ARCH="arm64";
          else ARCH="$RAW_ARCH"; fi
          
          echo "Detected Architecture: $ARCH"
          
          # Determine Version Strings
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            # RELEASE MODE (Stable)
            VERSION_STR="${{ github.ref_name }}"
            TARGET_TAG="${{ github.ref_name }}"
            PRERELEASE=false
            MAKE_LATEST=true
            echo "BUILD_MODE=stable" >> $GITHUB_ENV
          else
            # DEV MODE (Rolling Release)
            BRANCH_NAME="${{ github.ref_name }}"
            BRANCH_NAME=${BRANCH_NAME/\//-} 
            VERSION_STR="dev-${BRANCH_NAME}-${SHORT_SHA}"
            TARGET_TAG="latest-${BRANCH_NAME}"
            PRERELEASE=true
            MAKE_LATEST=false
            echo "BUILD_MODE=dev" >> $GITHUB_ENV
          fi
          
          # Define Package Name: vpn-watchdog-<OS>-<ARCH>.zip
          PKG_NAME="vpn-watchdog-${{ matrix.os_name }}-${ARCH}.zip"
          
          echo "Target Tag: $TARGET_TAG"
          echo "Package Name: $PKG_NAME"
          
          echo "TARGET_TAG=$TARGET_TAG" >> $GITHUB_ENV
          echo "IS_PRERELEASE=$PRERELEASE" >> $GITHUB_ENV
          echo "MAKE_LATEST=$MAKE_LATEST" >> $GITHUB_ENV
          echo "PKG_NAME=$PKG_NAME" >> $GITHUB_ENV
          
          # Overwrite src/version.py
          echo "BUILD_TAG = '$VERSION_STR'" > src/version.py
          echo "COMMIT_HASH = '${{ github.sha }}'" >> src/version.py
          echo "BUILD_DATE = '$CURRENT_DATE'" >> src/version.py

      # --- INSTALL DEPS (Ensure Ayatana & Legacy dev libs) ---
      - name: Install System Dependencies (Linux)
        if: matrix.os_name == 'linux' && steps.check_filter.outputs.skip != 'true'
        run: |
          sudo apt-get update
          # Install build dependencies for PyGObject and Cairo, plus AppIndicator libs
          # libcairo2-dev, libgirepository1.0-dev, pkg-config, and python3-dev are REQUIRED for building PyGObject
          sudo apt-get install -y \
            libcairo2-dev \
            libgirepository1.0-dev \
            pkg-config \
            python3-dev \
            libgtk-3-dev \
            gir1.2-appindicator3-0.1 \
            libappindicator3-dev \
            libayatana-appindicator3-dev \
            python3-tk

      - name: Install Python Dependencies
        if: steps.check_filter.outputs.skip != 'true'
        run: |
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build Binary
        if: steps.check_filter.outputs.skip != 'true'
        run: |
          pyinstaller --noconfirm --onefile --windowed --clean --name="vpn-watchdog" src/main.py

      # --- PACKAGING (ZIP) ---
      - name: Create ZIP Package
        if: steps.check_filter.outputs.skip != 'true'
        shell: bash
        run: |
          mkdir staging
          cp "dist/${{ matrix.binary_name }}" staging/
          cp "setup/${{ matrix.setup_script }}" staging/
          cp README.md staging/
          
          # Create ZIP
          cd staging
          # Use 7z or zip depending on OS availability, usually zip is available
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
             7z a -tzip "../${{ env.PKG_NAME }}" *
          else
             zip -r "../${{ env.PKG_NAME }}" .
          fi
          cd ..

      # --- UPLOAD TO RELEASE ---
      - name: Upload to Release
        if: steps.check_filter.outputs.skip != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TARGET_TAG }}
          files: ${{ env.PKG_NAME }}
          name: ${{ env.TARGET_TAG }}
          body: "Build: ${{ env.BUILD_TAG }} | Commit: ${{ github.sha }}"
          draft: false
          prerelease: ${{ env.IS_PRERELEASE }}
          overwrite_files: true
          make_latest: ${{ env.MAKE_LATEST }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}