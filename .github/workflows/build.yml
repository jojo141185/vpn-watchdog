name: Build and Release

on:
  push:
    tags:
      - 'v*' # Trigger on tags like v1.0, v2.0

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: vpn-watchdog
            asset_name: vpn-watchdog-linux
          - os: windows-latest
            artifact_name: vpn-watchdog.exe
            asset_name: vpn-watchdog-windows.exe
          - os: macos-latest
            artifact_name: vpn-watchdog
            asset_name: vpn-watchdog-macos

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # --- INJECT BUILD INFO ---
      # This overwrites src/version.py with real git data
      - name: Inject Build Info
        shell: bash
        run: |
          echo "BUILD_TAG = '${{ github.ref_name }}'" > src/version.py
          echo "COMMIT_HASH = '${{ github.sha }}'" >> src/version.py
          echo "BUILD_DATE = '$(date -u +'%Y-%m-%d %H:%M UTC')'" >> src/version.py
          cat src/version.py # Debug: show content in log

      - name: Install System Dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y gir1.2-appindicator3-0.1 libappindicator3-dev python3-tk

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build Binary
        run: |
          pyinstaller --onefile --windowed --clean --name="vpn-watchdog" src/main.py

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: dist/${{ matrix.artifact_name }}

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            vpn-watchdog-linux/vpn-watchdog
            vpn-watchdog-windows/vpn-watchdog.exe
            vpn-watchdog-macos/vpn-watchdog
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}