name: Build and Release Manager

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      target_os:
        description: 'Target Platform'
        required: true
        default: 'all'
        type: choice
        options: [all, ubuntu-latest, windows-latest, macos-latest]

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    if: |
      github.event_name != 'workflow_dispatch' || 
      inputs.target_os == 'all' || 
      inputs.target_os == matrix.os
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            os_short: linux
            exe_ext: ""
          - os: windows-latest
            os_short: windows
            exe_ext: ".exe"
          - os: macos-latest
            os_short: macos
            exe_ext: ""

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # --- VERSION LOGIC ---
      - name: Inject Version Info
        shell: bash
        run: |
          CURRENT_DATE=$(date -u +'%Y-%m-%d %H:%M UTC')
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          
          # Determine Build Mode and Target Tag
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            # OFFICIAL STABLE RELEASE (v1.0.0)
            VERSION_STR="${{ github.ref_name }}"
            TARGET_TAG="${{ github.ref_name }}"
            PRERELEASE=false
            echo "BUILD_MODE=stable" >> $GITHUB_ENV
          else
            # ROLLING DEV RELEASE (latest-main / latest-develop)
            BRANCH_NAME="${{ github.ref_name }}"
            VERSION_STR="dev-${BRANCH_NAME}-${SHORT_SHA}"
            TARGET_TAG="latest-${BRANCH_NAME}"
            PRERELEASE=true
            echo "BUILD_MODE=dev" >> $GITHUB_ENV
          fi
          
          echo "Target Tag: $TARGET_TAG"
          echo "TARGET_TAG=$TARGET_TAG" >> $GITHUB_ENV
          echo "IS_PRERELEASE=$PRERELEASE" >> $GITHUB_ENV
          
          # Overwrite src/version.py
          echo "BUILD_TAG = '$VERSION_STR'" > src/version.py
          echo "COMMIT_HASH = '${{ github.sha }}'" >> src/version.py
          echo "BUILD_DATE = '$CURRENT_DATE'" >> src/version.py
          
          cat src/version.py

      - name: Install System Dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y gir1.2-appindicator3-0.1 libappindicator3-dev python3-tk

      - name: Install Python Dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build Binary
        run: |
          pyinstaller --noconfirm --onefile --windowed --clean --name="vpn-watchdog" src/main.py

      # --- UPLOAD TO RELEASE ---
      # This handles both stable tags and moving "rolling" tags
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TARGET_TAG }}
          files: |
            dist/vpn-watchdog${{ matrix.exe_ext }}
          name: ${{ env.TARGET_TAG }}
          body: "Build: ${{ env.BUILD_TAG }} | Commit: ${{ github.sha }}"
          draft: false
          prerelease: ${{ env.IS_PRERELEASE }}
          # Force overwrite assets for rolling releases
          overwrite: true 
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}